# AUTOGENERATED! DO NOT EDIT! File to edit: 00_core.ipynb (unless otherwise specified).

__all__ = ['GH_HOST', 'GhVerb', 'GhApi']

# Cell
from fastcore.utils import *
from fastcore.foundation import *
from fastcore.meta import *

import pprint,inspect,json,copy
from inspect import signature,Parameter,Signature
from urllib.parse import urlencode
from .metadata import funcs
from urllib.request import Request

# Cell
GH_HOST = "https://api.github.com"
_DOC_URL = 'https://docs.github.com/'

# Cell
class GhVerb:
    __slots__ = 'path,verb,tag,name,summary,url,route_ps,params,data,hdrs,__doc__'.split(',')
    def __init__(self, path, verb, oper, summary, url, params, data, hdrs, kwargs):
        tag,name = oper.split('/')
        name = name.replace('-','_')
        path,route_ps,xtra = partial_format(path, **kwargs)
        __doc__ = summary
        store_attr()

    def __call__(self, *args, **kwargs):
        flds = [o for o in self.route_ps+self.params+self.data if o not in kwargs]
        for a,b in zip(args,flds): kwargs[b]=a
        route_p,query_p,data_p = [{p:kwargs[p] for p in o if p in kwargs}
                                 for o in (self.route_ps,self.params,self.data)]
        return dict2obj(urlsend(GH_HOST+self.path, self.verb, headers=self.hdrs,
                              route=route_p, query=query_p, data=data_p))

    @property
    def __signature__(self): return mk_sig(self.route_ps, {})
    __call__.__signature__ = __signature__

    def _repr_markdown_(self):
        params = ','.join(self.params+self.data)
        return f"[{self.tag}/{self.name}]({_DOC_URL}{self.url})({params}): {self.summary}"
    __repr__ = _repr_markdown_

class _GhVerbGroup(AttrDict):
    def __init__(self, verbs): super().__init__(**{o.name:o for o in verbs})
    def _repr_markdown_(self): return "\n".join(f'- [{k}]({_DOC_URL}{v.url})' for k,v in self.items())

# Cell
class GhApi:
    def __init__(self, owner=None, repo=None, token=None, **kwargs):
        self._headers = { 'Accept': 'application/vnd.github.v3+json' }
        if token: self._headers['Authorization'] = 'token ' + token
        if owner: kwargs['owner'] = owner
        if repo:  kwargs['repo' ] = repo
        funcs_ = L(funcs).starmap(GhVerb, hdrs=self._headers, kwargs=kwargs)
        self._fs = {k:_GhVerbGroup(v) for k,v in groupby(funcs_, 'tag').items()}

    def __dir__(self): return super().__dir__() + list(self._fs)

    def __getattr__(self,k):
        if k in self._fs: return self._fs[k]
        raise AttributeError(k)